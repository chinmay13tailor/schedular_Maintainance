<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--slate:#374151;--gray:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .spacer{flex:1}
  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .filters{grid-column:1/-1;display:flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .filters label{font-size:12px;color:#64748b;margin-right:4px}

  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
  .status-postponed{background:var(--gray)}

  .muted{color:var(--muted)}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(640px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  .fc-toolbar-chunk.legends{display:flex;gap:14px;align-items:center;margin-left:8px}
  .legend-box{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  .legend-planned{background:var(--blue)}
  .legend-inprogress{background:var(--amber)}
  .legend-completed{background:var(--green)}
  .legend-cancelled{background:var(--red)}
  .legend-postponed{background:var(--gray)}

  /* PDF render fixes */
  #msReport, #msReportClone, #msReportClone *{
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <!-- Filters -->
  <div class="filters">
    <label>Machine</label>
    <select id="filtMa" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Type</label>
    <select id="filtTy" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
    </select>

    <label>Status</label>
    <select id="filtSt" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
    </select>

    <label>Technician</label>
    <select id="filtTech" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <button class="btn ghost" id="btnApplyFilters" type="button">Update</button>
    <button class="btn" id="btnResetFilters" type="button">Reset</button>
  </div>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Maintenance task</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
      <button class="btn primary" id="btnReportDownload" type="button">Download PDF</button>
    </div>
  </aside>
</div>

<!-- Hidden Report Template -->
<div id="msReport" style="display:none">
  <div class="r-wrap" style="padding:20px;font-family:sans-serif;">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <img src="PlantwizLogo.png" style="height:40px">
      <div style="text-align:center">
        <h2 style="margin:0;">Pima Controls Pvt. Ltd</h2>
        <div style="font-size:12px;color:#64748b">Block No.298, Nr. Bacha Motors, Sanathal Cross Road, Ahmedabad</div>
      </div>
      <img src="PimaLogo.png" style="height:40px">
    </header>
    <h3 style="margin:10px 0;">Maintenance Task Report</h3>
    <div id="rContent" style="font-size:13px;"></div>
    <footer style="margin-top:20px;font-size:11px;color:#64748b;text-align:center">Generated by Maintenance Scheduler</footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// state, filters, calendar setup hereâ€¦
// (keep your existing scheduler code unchanged)

// Render task details into the report
function renderReportFrom(ev){
  const p = ev.extendedProps;
  document.getElementById('rContent').innerHTML = `
    <div><b>Title:</b> ${p.MS_Title||''}</div>
    <div><b>Machine:</b> ${p.MS_Machine||''}</div>
    <div><b>Type:</b> ${p.MS_Type||''}</div>
    <div><b>Priority:</b> ${p.MS_Priority||''}</div>
    <div><b>Status:</b> ${p.MS_Status||''}</div>
    <div><b>Scheduled:</b> ${new Date(p.MS_Start).toLocaleString()} - ${new Date(p.MS_End).toLocaleString()}</div>
    <div><b>Technicians:</b> ${p.MS_Technicians||''}</div>
    <div><b>Description:</b> ${p.MS_Description||''}</div>
  `;
}

// PDF Download
async function downloadMaintenancePdf(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  renderReportFrom(state.selectedEvent);

  const source = document.getElementById('msReport');
  const clone  = source.cloneNode(true);
  clone.id = 'msReportClone';
  clone.style.display   = 'block';
  clone.style.position  = 'fixed';
  clone.style.left      = '-10000px';
  document.body.appendChild(clone);

  const content = clone.querySelector('.r-wrap');

  const imgs = Array.from(content.querySelectorAll('img'));
  await Promise.all(imgs.map(img => new Promise(res=>{
    if (img.complete) return res();
    img.onload = res;
    img.onerror = ()=>{ img.style.display='none'; res(); };
  })));

  await new Promise(r=>setTimeout(r, 50));

  const title = (state.selectedEvent.extendedProps.MS_Title||'Maintenance_Task').replace(/[^\w\-]+/g,'_');
  const ts    = state.selectedEvent.extendedProps.__ts || Date.now();

  const opts = {
    margin: [10,10,12,10],
    filename: `${title}_${ts}.pdf`,
    image: { type:'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 2,
      useCORS: true,
      backgroundColor: '#ffffff',
      letterRendering: true
    },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
    pagebreak: { mode:['css','legacy'] }
  };

  try{
    await html2pdf().set(opts).from(content).save();
  } finally {
    clone.remove();
  }
}
document.getElementById('btnReportDownload').addEventListener('click', downloadMaintenancePdf);
</script>
</body>
</html>
