<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--slate:#111827;--gray:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* ======= LAYOUT (Header | Filters | Rail + Main + Side) ======= */
  .app{
    display:grid;
    grid-template-columns:64px 1fr 320px;     /* rail | main | right side */
    grid-template-rows:auto auto 1fr;         /* header | filters | content row */
    gap:16px;
    min-height:100vh;
    padding:16px;
  }

  header{
    grid-column:1 / -1;
    display:flex;gap:10px;align-items:center;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .spacer{flex:1}

  /* Filters (span main + side) */
  .filters{
    grid-column:2 / -1;
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .filters label{font-size:12px;color:#64748b;margin-right:4px}

  /* Left navigation rail */
  .rail{
    grid-column:1 / 2;
    grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:8px;
    display:flex;flex-direction:column;align-items:center;gap:8px;
    position:sticky;top:16px;height:fit-content
  }
  .rail button{
    width:48px;height:48px;border-radius:12px;border:1px solid var(--ring);
    background:#fff;cursor:pointer;display:grid;place-items:center;font-size:18px
  }
  .rail button.active{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15)}
  .rail button:hover{background:#f8fafc}

  /* Main area (calendar/list container) */
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #mainCard{grid-column:2 / 3;grid-row:3 / 4;min-height:560px}
  #calendar{min-height:560px}

  /* Right side details */
  .side{
    grid-column:3 / 4;grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;
    position:sticky;top:16px;height:fit-content
  }

  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .muted{color:#64748b}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  /* FullCalendar styles */
  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
  .status-postponed{background:var(--gray)}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  .fc-toolbar-chunk.legends{display:flex;gap:14px;align-items:center;margin-left:8px}
  .legend-box{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  .legend-planned{background:var(--blue)}
  .legend-inprogress{background:var(--amber)}
  .legend-completed{background:var(--green)}
  .legend-cancelled{background:var(--red)}
  .legend-postponed{background:var(--gray)}

  /* ===== List tables ===== */
  .toolbar-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--ring)}
  .table-wrap{overflow:auto;max-height:68vh}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
  th,td{border-bottom:1px solid var(--ring);padding:8px 10px;text-align:left;white-space:nowrap}
  tr:hover{background:#f9fafb;cursor:pointer}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:11px}
  .badge.planned{background:var(--blue)} .badge.inprogress{background:var(--amber)}
  .badge.completed{background:var(--green)} .badge.cancelled{background:var(--red)} .badge.postponed{background:var(--gray)}

  /* ===== Tips cards ===== */
  .tips-wrap{padding:12px}
  .tips-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .tip-card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  .tip-card header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px dashed var(--ring)}
  .tip-title{font-weight:900}
  .tip-body{padding:10px}
  .tip-ok{color:#16a34a;font-weight:900}
  .tip-warn{color:#b45309;font-weight:900}
  .tip-bad{color:#dc2626;font-weight:900}
  .muter{color:#6b7280;font-size:12px}

  /* ===== PDF styles ===== */
  #pdfRoot{position:fixed;left:-99999px;top:-99999px;width:900px;background:#fff;color:#111827}
  .r-wrap{padding:18px;border:1px solid #e5e7eb;border-radius:14px}
  .r-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding-bottom:12px;margin-bottom:12px}
  .r-head .logos img{height:36px;object-fit:contain}
  .r-title{text-align:center}
  .r-title h1{margin:2px 0 4px;font-size:18px}
  .r-title .addr{font-size:11px;color:#6b7280}
  .r-meta{font-size:11px;text-align:right;color:#374151}
  .r-section{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb}
  .r-sec-h{background:#0f172a;color:#fff;padding:8px 10px;font-weight:800}
  .r-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:10px}
  .r-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .r-row{display:grid;grid-template-columns:140px 1fr;gap:12px;padding:10px}
  .r-row .box{border:1px solid #e5e7eb;border-radius:10px;padding:8px;min-height:48px}
  .r-table{width:100%;border-collapse:collapse;font-size:12px}
  .r-table th,.r-table td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
  .r-foot{display:flex;gap:12px;padding:12px}
  .sign{flex:1;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;min-height:72px}
  .r-fine{display:flex;justify-content:space-between;font-size:10px;color:#6b7280;padding:8px 2px}

  /* ===== Modal / Overlay ===== */
  .overlay{
    position:fixed;inset:0;background:rgba(15,23,42,.45);
    display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;
  }
  .modal{
    width:min(680px,92vw);max-height:90vh;overflow:auto;
    background:#fff;border:1px solid var(--ring);border-radius:14px;
    box-shadow:0 24px 48px rgba(0,0,0,.28)
  }
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <!-- Left Navigation Rail -->
  <nav class="rail" aria-label="Quick views">
    <button id="navCalendar" class="active" title="Calendar" type="button">üìÖ</button>
    <button id="navTips" title="Tips" type="button">üí°</button>
    <button id="navList" title="List View" type="button">üìã</button>
    <button id="navMissed" title="Missed Maintenance" type="button">‚è∞</button>
  </nav>

  <!-- Filters -->
  <div class="filters">
    <label>Machine</label>
    <select id="filtMa" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Type</label>
    <select id="filtTy" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
    </select>

    <label>Status</label>
    <select id="filtSt" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
    </select>

    <label>Technician</label>
    <select id="filtTech" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <button class="btn ghost" id="btnApplyFilters" type="button">Update</button>
    <button class="btn" id="btnResetFilters" type="button">Reset</button>
  </div>

  <!-- Main area: Calendar/List/Tips/Missed -->
  <div id="mainCard" class="card">
    <!-- Calendar view -->
    <div id="viewCalendar"><div id="calendar"></div></div>

    <!-- List view -->
    <div id="viewList" style="display:none;">
      <div class="toolbar-row" id="listToolbar" style="gap:12px;">
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" id="listPrev" type="button">‚Äπ</button>
          <button class="btn" id="listToday" type="button">today</button>
          <button class="btn" id="listNext" type="button">‚Ä∫</button>
        </div>
        <strong id="listTitle" style="font-size:15px;">‚Äî</strong>
        <div class="fc-toolbar-chunk legends">
          <span><span class="legend-box legend-planned"></span> Planned</span>
          <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
          <span><span class="legend-box legend-completed"></span> Completed</span>
          <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
          <span><span class="legend-box legend-postponed"></span> Postponed</span>
          <span class="muted" id="listCount" style="margin-left:14px"></span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="listTable">
          <thead><tr>
            <th>Date</th><th>Start</th><th>Machine</th><th>Title</th><th>Type</th><th>Techs</th><th>Status</th><th>Priority</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tips view -->
    <div id="viewTips" style="display:none;">
      <div class="toolbar-row" style="gap:12px;">
        <strong style="font-size:15px;">Supervisor Tips</strong>
        <div class="fc-toolbar-chunk legends" style="margin-left:auto">
          <span><span class="legend-box legend-planned"></span> Planned</span>
          <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
          <span><span class="legend-box legend-completed"></span> Completed</span>
          <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
          <span><span class="legend-box legend-postponed"></span> Postponed</span>
        </div>
      </div>
      <div class="tips-wrap">
        <div id="tipsRuntimeInfo" class="muter" style="margin:6px 2px 10px 2px"></div>
        <div class="tips-grid" id="tipsGrid">
          <!-- runtime + preventive coverage tips injected here -->
        </div>
      </div>
    </div>

    <!-- Missed placeholder -->
    <div id="viewMissed" style="display:none;padding:18px;">
      <div class="empty">Missed view coming soon.</div>
    </div>
  </div>

  <!-- Right details -->
  <aside class="side">
    <h3 class="h6">Maintenance task</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
      <button class="btn"         id="btnPDF"    type="button">Download PDF</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add maintenance task</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Quarterly Service">
      </div>

      <div>
        <label>Machine</label>
        <!-- Enforced machine list to avoid casing/typos -->
        <select id="fMachine" class="input">
          <option value="">Select machine</option>
          <option>MC_01</option>
          <option>MC_02</option>
          <option>MC_03</option>
        </select>
      </div>
      <div>
        <label>Type</label>
        <select id="fType" class="input">
          <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
        </select>
      </div>

      <div>
        <label>Priority (1=High)</label>
        <select id="fPriority" class="input">
          <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input id="fDate" class="input" type="date">
      </div>

      <div>
        <label>Start</label>
        <input id="fTimeStart" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>End</label>
        <input id="fTimeEnd" class="input" type="time" value="11:00">
      </div>

      <div class="row-full">
        <label>Technician(s)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="techOne" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addTechBtn" type="button">+</button>
        </div>
        <div id="techChips" class="chips"></div>
      </div>

      <div class="row-full">
        <label>Checklist points (comma separated) <span class="muted">(stored in MS_Task)</span></label>
        <textarea id="fTasks" class="input" rows="2" placeholder="e.g., Check oil level, Replace air filter, Inspect belts"></textarea>
      </div>

      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
        </select>
      </div>
      <div class="row-full">
        <label>Description / Notes</label>
        <textarea id="fDesc" class="input" rows="2" placeholder="Optional notes"></textarea>
      </div>
    </div>
    <footer>
      <button class="btn primary" id="saveTask" type="button">Save</button>
    </footer>
  </div>
</div>

<!-- Hidden PDF root -->
<div id="pdfRoot" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

// Flags
var ATTR_MS_SAVE    = "MS_Save_Button";
var ATTR_MS_UPDATE  = "MS_Update_Buttton";
var ATTR_MS_UPD_TS  = "MS_Update_Timestamp";

// Telemetry keys
var KEYS = [
  "MS_Title","MS_Machine","MS_Type","MS_Priority",
  "MS_Date","MS_Start","MS_End",
  "MS_Status","MS_Description","MS_Technicians","MS_Task"
];

// Runtime telemetry per machine (for now only MC_01 provided as per your note)
var RUNTIME_KEYS = {
  "MC_01": "Currentday_Runtime"
  // "MC_02": "Currentday_Runtime_MC_02", // when available
  // "MC_03": "Currentday_Runtime_MC_03"  // when available
};

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pad2(n){ return String(n).padStart(2,"0"); }
function normMachine(s){ return String(s||"").trim().toUpperCase(); }
function hhmmToMs(baseDate, hhmm){
  var p = String(hhmm||"00:00").split(":"); var h=+p[0]||0, m=+p[1]||0;
  var d = new Date(baseDate); d.setHours(h,m,0,0); return d.getTime();
}
function msToHHMM(ms){
  var d = new Date(ms), h = d.getHours()%12 || 12, ampm = d.getHours()>=12?"PM":"AM";
  return pad2(h)+":"+pad2(d.getMinutes())+" "+ampm;
}
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="in-progress" || v==="inprogress") return "status-inprogress";
  if (v==="completed") return "status-completed";
  if (v==="postponed") return "status-postponed";
  return "status-planned";
}
function eventContent(arg){
  var p = arg.event.extendedProps;
  var time = msToHHMM(p.MS_Start);
  var title = p.MS_Title || "Maintenance";
  return { html: '<span>'+escapeHtml(time)+' ‚Äî '+escapeHtml(title)+'</span>' };
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }

/************ STATE ************/
var state = {
  view: "calendar",
  calendar:null, lastRange:null, selectedEvent:null, mode:"create",
  pickedDate: null,
  technicians: [],
  filters: { ma:"__ALL__", ty:"__ALL__", st:"__ALL__", tech:"__ALL__" },
  lastEventsFull: [],
  listMonth: null,          // Date pointing to the visible month in List View
  lastListRange: null
};

/************ READ ************/
function readRange(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(",")) +
            "&startTs=" + rangeStart.getTime() +
            "&endTs="   + rangeEnd.getTime() +
            "&limit=5000";
  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: "+t); }))
    .then(tsObj => {
      var map = {};
      Object.keys(tsObj || {}).forEach(k => {
        (tsObj[k]||[]).forEach(p => {
          var ts = Number(p.ts);
          var rec = map[ts] || (map[ts] = { ts: ts });
          rec[k] = p.value;
        });
      });
      var out = [];
      Object.keys(map).forEach(tsStr => {
        var r = map[tsStr];
        var st = Number(r.MS_Start || r.ts);
        var en = Number(r.MS_End || (st + 60*60*1000));
        if (!st || !en) return;
        // normalize machine code
        var mach = normMachine(r.MS_Machine || "");
        out.push({
          id: "ts-"+r.ts,
          title: r.MS_Title || "Maintenance",
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.MS_Status)],
          extendedProps: {
            MS_Title: r.MS_Title || "",
            MS_Machine: mach,
            MS_Type: r.MS_Type || "Preventive",
            MS_Priority: r.MS_Priority != null ? r.MS_Priority : 3,
            MS_Date: r.MS_Date || null,
            MS_Start: st,
            MS_End: en,
            MS_Status: r.MS_Status || "Planned",
            MS_Description: r.MS_Description || "",
            MS_Technicians: r.MS_Technicians || "",
            MS_Task: r.MS_Task || "",
            __ts: r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ FILTERS ************/
function populateFilters(events){
  var mas = new Set(), techs = new Set();
  events.forEach(ev=>{
    var p = ev.extendedProps||{};
    if (p.MS_Machine) mas.add(normMachine(p.MS_Machine));
    if (p.MS_Technicians){
      String(p.MS_Technicians).split(",").map(s=>s.trim()).filter(Boolean).forEach(t=>techs.add(t));
    }
  });
  function fill(sel, set){
    var el = $(sel); var val = el.value || "__ALL__";
    el.innerHTML = '<option value="__ALL__">All</option>' +
      Array.from(set).sort().map(v=>'<option>'+escapeHtml(v)+'</option>').join('');
    if ([...set].includes(val)) el.value = val; else el.value="__ALL__";
  }
  fill("#filtMa", mas); fill("#filtTech", techs);
}
function applyFilters(events){
  var ma=$("#filtMa").value, ty=$("#filtTy").value, st=$("#filtSt").value, tech=$("#filtTech").value;
  state.filters = { ma, ty, st, tech };
  return events.filter(ev=>{
    var p = ev.extendedProps||{};
    var okMa = (ma==="__ALL__" || normMachine(p.MS_Machine)===normMachine(ma));
    var okTy = (ty==="__ALL__" || String(p.MS_Type)===ty);
    var okSt = (st==="__ALL__" || String(p.MS_Status)===st);
    var okTe = (tech==="__ALL__" || (p.MS_Technicians||"").split(",").map(s=>s.trim()).includes(tech));
    return okMa && okTy && okSt && okTe;
  });
}

/************ LIST RENDER ************/
function badge(status){
  var c = String(status||"Planned").toLowerCase().replace("in-progress","inprogress");
  return '<span class="badge '+c+'">'+escapeHtml(status||"Planned")+'</span>';
}
function renderList(events){
  var tbody = $("#listTable tbody"); tbody.innerHTML = "";
  events.forEach(ev=>{
    var p = ev.extendedProps;
    var tr = document.createElement("tr");
    tr.innerHTML =
      '<td>'+escapeHtml(new Date(p.MS_Start).toLocaleDateString())+'</td>'+
      '<td>'+escapeHtml(msToHHMM(p.MS_Start))+'</td>'+
      '<td>'+escapeHtml(p.MS_Machine||"-")+'</td>'+
      '<td>'+escapeHtml(p.MS_Title||"-")+'</td>'+
      '<td>'+escapeHtml(p.MS_Type||"-")+'</td>'+
      '<td>'+escapeHtml(p.MS_Technicians||"-")+'</td>'+
      '<td>'+badge(p.MS_Status)+'</td>'+
      '<td>'+escapeHtml(String(p.MS_Priority??""))+'</td>';
    tr.addEventListener("click", function(){
      showDetails({ extendedProps: p });
    });
    tbody.appendChild(tr);
  });
  $("#listCount").textContent = "Showing "+events.length+" task(s)";
}

/************ LIST MONTH LOADER ************/
function updateListTitle(d){
  var fmt = d.toLocaleString(undefined,{month:"long", year:"numeric"});
  $("#listTitle").textContent = fmt;
}
function loadListMonth(baseDate){
  state.listMonth = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
  var s = startOfMonth(state.listMonth);
  var e = endOfMonth(state.listMonth);
  state.lastListRange = {start:s, end:e};
  updateListTitle(state.listMonth);

  loading("Loading‚Ä¶");
  return readRange(s, e).then(function(events){
    populateFilters(events);
    state.lastEventsFull = events.slice();
    var filtered = applyFilters(events);
    renderList(filtered);
    loading("Loaded "+filtered.length+" task(s)");
  }).catch(function(err){
    console.error(err); loading(err.message||"Failed to load");
  });
}

/************ VIEW SWITCH ************/
function setActiveButton(id){
  ["navCalendar","navTips","navList","navMissed"].forEach(k=>$("#"+k).classList.remove("active"));
  $("#"+id).classList.add("active");
}
function showView(name){
  state.view = name;
  $("#viewCalendar").style.display = (name==="calendar")?"block":"none";
  $("#viewList").style.display     = (name==="list")?"block":"none";
  $("#viewTips").style.display     = (name==="tips")?"block":"none";
  $("#viewMissed").style.display   = (name==="missed")?"block":"none";
  setActiveButton(name==="calendar"?"navCalendar":name==="tips"?"navTips":name==="list"?"navList":"navMissed");

  if (name==="list"){
    if (!state.listMonth){
      var seed = state.calendar ? state.calendar.getDate() : new Date();
      loadListMonth(seed);
    } else {
      var s = startOfMonth(state.listMonth), e=endOfMonth(state.listMonth);
      readRange(s,e).then(function(events){
        state.lastEventsFull = events.slice();
        populateFilters(events);
        renderList(applyFilters(events));
      });
    }
  } else if (name==="calendar"){
    refreshCalendar();
  } else if (name==="tips"){
    renderTips();
  } else {
    loading("");
  }
}
$("#navCalendar").addEventListener("click", ()=>showView("calendar"));
$("#navTips").addEventListener("click",     ()=>showView("tips"));
$("#navList").addEventListener("click",     ()=>showView("list"));
$("#navMissed").addEventListener("click",   ()=>showView("missed"));

/* List month toolbar buttons */
$("#listPrev").addEventListener("click", function(){
  var d = state.listMonth ? new Date(state.listMonth) : new Date();
  d.setMonth(d.getMonth()-1); loadListMonth(d);
});
$("#listNext").addEventListener("click", function(){
  var d = state.listMonth ? new Date(state.listMonth) : new Date();
  d.setMonth(d.getMonth()+1); loadListMonth(d);
});
$("#listToday").addEventListener("click", function(){
  loadListMonth(new Date());
});

/************ FILTER BUTTONS HOOKED TO CURRENT VIEW ************/
function refreshCalendar(){
  if (!state.calendar || !state.lastRange) return;
  var filtered = applyFilters(state.lastEventsFull);
  state.calendar.removeAllEvents(); state.calendar.addEventSource(filtered);
  loading("Loaded "+filtered.length+" task(s)");
}
$("#btnApplyFilters").addEventListener("click", function(){
  if (state.view==="list"){
    if (state.listMonth) loadListMonth(state.listMonth);
  } else if (state.view==="calendar"){
    refreshCalendar();
  } else if (state.view==="tips"){
    renderTips();
  }
});
$("#btnResetFilters").addEventListener("click", function(){
  $("#filtMa").value="__ALL__"; $("#filtTy").value="__ALL__"; $("#filtSt").value="__ALL__"; $("#filtTech").value="__ALL__";
  state.filters = { ma:"__ALL__", ty:"__ALL__", st:"__ALL__", tech:"__ALL__" };
  if (state.view==="list"){
    if (state.listMonth) loadListMonth(state.listMonth);
  } else if (state.view==="calendar"){
    refreshCalendar();
  } else if (state.view==="tips"){
    renderTips();
  }
});

/************ AUTO-REFRESH (5s, 3 min max) ************/
var _autoTimer=null, _autoDeadline=0;
function stopAutoRefresh(){ if(_autoTimer){ clearInterval(_autoTimer); _autoTimer=null; } }
function startAutoRefresh(expectedTs, predicate){
  stopAutoRefresh();
  _autoDeadline = Date.now() + 3*60*1000;
  _autoTimer = setInterval(function(){
    if (Date.now()>_autoDeadline){ stopAutoRefresh(); loading("Stopped: timeout waiting for telemetry update"); return; }
    if (state.view==="list" && state.lastListRange){
      readRange(state.lastListRange.start, state.lastListRange.end)
        .then(function(events){
          state.lastEventsFull = events.slice();
          populateFilters(events);
          renderList(applyFilters(events));
          if (expectedTs!=null){
            var found = events.find(ev => String(ev.extendedProps.__ts) === String(expectedTs));
            if (found){
              if (typeof predicate==="function"){ try{ if(predicate(found)){ stopAutoRefresh(); loading("Update detected ‚úì"); } }catch(e){} }
              else { stopAutoRefresh(); loading("Update detected ‚úì"); }
            }
          }
        })
        .catch(function(err){ console.error(err); loading("Auto-refresh error: "+(err.message||err)); });
      return;
    }
    if (!state.lastRange) return;
    readRange(state.lastRange.start, state.lastRange.end)
      .then(function(events){
        state.lastEventsFull = events.slice();
        populateFilters(events);
        refreshCalendar();
        $("#details").className="empty"; $("#details").textContent="Select a task"; $("#sideActions").style.display="none";
        if (expectedTs!=null){
          var found = events.find(ev => String(ev.extendedProps.__ts) === String(expectedTs));
          if (found){
            if (typeof predicate==="function"){ try{ if(predicate(found)){ stopAutoRefresh(); loading("Update detected ‚úì"); } }catch(e){} }
            else { stopAutoRefresh(); loading("Update detected ‚úì"); }
          }
        }
      })
      .catch(function(err){ console.error(err); loading("Auto-refresh error: "+(err.message||err)); });
  }, 5000);
}

/************ WRITE ************/
function writeAttributes(payload, opts){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";
  var body = {
    MS_Title: payload.MS_Title,
    MS_Machine: normMachine(payload.MS_Machine),
    MS_Type: payload.MS_Type,
    MS_Priority: payload.MS_Priority,
    MS_Date: payload.MS_Date,
    MS_Start: payload.MS_Start,
    MS_End: payload.MS_End,
    MS_Status: payload.MS_Status || "Planned",
    MS_Description: payload.MS_Description || "",
    MS_Technicians: payload.MS_Technicians || "",
    MS_Task: payload.MS_Task || ""
  };
  if (opts && opts.mode==="create"){
    body[ATTR_MS_SAVE] = false; // trigger create path
  } else if (opts && (opts.mode==="update" || opts.mode==="cancel")){
    body[ATTR_MS_UPDATE] = true;
    if (payload[ATTR_MS_UPD_TS]) body[ATTR_MS_UPD_TS] = payload[ATTR_MS_UPD_TS];
  }
  return fetch(url,{
    method:"POST",
    headers:{ "X-Authorization":"Bearer "+JWT, "Content-Type":"application/json" },
    body: JSON.stringify(body)
  }).then(res=>res.ok?null:res.text().then(t=>{throw new Error("Attribute write failed: "+t);})); 
}

/************ DETAILS ************/
function showDetails(ev){
  state.selectedEvent = ev;
  var p = ev.extendedProps; function fmt(v){ return v?new Date(Number(v)).toLocaleString():"-"; }
  $("#details").className = "";
  $("#details").innerHTML =
    '<div class="kpi">'+
      '<span>Base ts</span><span>'+escapeHtml(String(p.__ts||"-"))+'</span>'+
      '<span>Title</span><span>'+escapeHtml(p.MS_Title||"-")+'</span>'+
      '<span>Machine</span><span>'+escapeHtml(p.MS_Machine||"-")+'</span>'+
      '<span>Type</span><span>'+escapeHtml(p.MS_Type||"-")+'</span>'+
      '<span>Priority</span><span>'+escapeHtml(String(p.MS_Priority??""))+'</span>'+
      '<span>Status</span><span>'+escapeHtml(p.MS_Status||"Planned")+'</span>'+
      '<span>Technicians</span><span>'+escapeHtml(p.MS_Technicians||"-")+'</span>'+
      '<span>Start</span><span>'+fmt(p.MS_Start)+'</span>'+
      '<span>End</span><span>'+fmt(p.MS_End)+'</span>'+
      '<span>Tasks</span><span>'+escapeHtml(p.MS_Task||"-")+'</span>'+
      '<span>Description</span><span>'+escapeHtml(p.MS_Description||"-")+'</span>'+
    '</div>';
  $("#sideActions").style.display = "flex";
}

/************ MODAL + TECH CHIPS ************/
var overlay = $("#overlay");
function busy(on){
  ["saveTask","btnCancel","btnEdit","btnNew","btnPDF"].forEach(id=>{ var el=$("#"+id); if(el) el.disabled=!!on; });
}
function refreshTechChips(){
  var box=$("#techChips"); box.innerHTML="";
  state.technicians.forEach(function(name, idx){
    var chip=document.createElement("span"); chip.className="chip";
    chip.innerHTML='<span>'+escapeHtml(name)+'</span><button type="button" aria-label="Remove">‚úï</button>';
    chip.querySelector("button").addEventListener("click", function(){ state.technicians.splice(idx,1); refreshTechChips(); });
    box.appendChild(chip);
  });
}
function addOneTech(){
  var v=($("#techOne").value||"").trim(); if(!v) return;
  if(state.technicians.includes(v)){ alert("Already added: "+v); return; }
  state.technicians.push(v); $("#techOne").value=""; refreshTechChips();
}
$("#addTechBtn").addEventListener("click", addOneTech);
$("#techOne").addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); addOneTech(); } });

function closeOverlay(){
  overlay.style.display="none"; document.body.style.overflow="";
}
$("#closeModal").addEventListener("click", closeOverlay);

$("#btnNew").addEventListener("click", function(){ openModalForDate(new Date()); });
$("#saveTask").addEventListener("click", function(){ if (state.mode==="update") onUpdate(); else onCreate(); });

$("#btnEdit").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  var p = state.selectedEvent.extendedProps;
  state.mode="update"; $("#modalTitle").textContent="Update maintenance task"; $("#saveTask").textContent="Update";

  var date = new Date(p.MS_Date || p.MS_Start);
  state.pickedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

  $("#fTitle").value    = p.MS_Title || "";
  $("#fMachine").value  = normMachine(p.MS_Machine || "");
  $("#fType").value     = p.MS_Type || "Preventive";
  $("#fPriority").value = String(p.MS_Priority != null ? p.MS_Priority : "3");
  $("#fDate").value     = new Date(state.pickedDate.getTime() - state.pickedDate.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $("#fTimeStart").value= pad2(new Date(p.MS_Start).getHours())+":"+pad2(new Date(p.MS_Start).getMinutes());
  $("#fTimeEnd").value  = pad2(new Date(p.MS_End).getHours())+":"+pad2(new Date(p.MS_End).getMinutes());
  state.technicians     = (p.MS_Technicians||"").split(",").map(s=>s.trim()).filter(Boolean);
  refreshTechChips(); $("#techOne").value="";
  $("#fStatus").value   = p.MS_Status || "Planned";
  $("#fDesc").value     = p.MS_Description || "";
  $("#fTasks").value    = p.MS_Task || "";

  overlay.style.display="flex"; document.body.style.overflow="hidden";
});

$("#btnCancel").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  if(!confirm("Cancel this maintenance task?")) return;

  var p = state.selectedEvent.extendedProps;
  var payload = {
    MS_Title: p.MS_Title || "",
    MS_Machine: normMachine(p.MS_Machine || ""),
    MS_Type: p.MS_Type || "Preventive",
    MS_Priority: p.MS_Priority != null ? p.MS_Priority : 3,
    MS_Date: p.MS_Date || null,
    MS_Start: p.MS_Start,
    MS_End: p.MS_End,
    MS_Status: "Cancelled",
    MS_Description: p.MS_Description || "",
    MS_Technicians: p.MS_Technicians || "",
    MS_Task: p.MS_Task || ""
  };
  payload[ATTR_MS_UPD_TS] = p.__ts;

  loading("Cancelling‚Ä¶"); busy(true);
  writeAttributes(payload, { mode:"cancel" })
    .then(function(){
      startAutoRefresh(payload[ATTR_MS_UPD_TS], function(found){
        return String(found.extendedProps.MS_Status).toLowerCase()==="cancelled";
      });
    })
    .catch(err=>{ console.error(err); alert(err.message||"Failed to cancel"); })
    .finally(()=>{ busy(false); });
});

/************ CREATE / UPDATE ************/
function openModalForDate(jsDate){
  state.mode="create";
  state.pickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());
  $("#modalTitle").textContent="Add maintenance task"; $("#saveTask").textContent="Save";

  $("#fTitle").value="";
  $("#fMachine").value=""; // user must choose MC_01/02/03
  $("#fType").value="Preventive";
  $("#fPriority").value="3";
  $("#fDate").value = new Date(state.pickedDate.getTime() - state.pickedDate.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $("#fTimeStart").value="09:00"; $("#fTimeEnd").value="11:00";
  state.technicians=[]; refreshTechChips(); $("#techOne").value="";
  $("#fStatus").value="Planned"; $("#fDesc").value="";
  $("#fTasks").value="";
  overlay.style.display="flex"; document.body.style.overflow="hidden";
}
function collectPayload(){
  var dateStr = $("#fDate").value;
  var parts = dateStr ? dateStr.split("-").map(Number) : null;
  var base = parts ? new Date(parts[0], parts[1]-1, parts[2]) : (state.pickedDate || new Date());
  return {
    MS_Title: ($("#fTitle").value||"").trim(),
    MS_Machine: normMachine($("#fMachine").value || ""),
    MS_Type: $("#fType").value || "Preventive",
    MS_Priority: parseInt($("#fPriority").value, 10) || 3,
    MS_Date: new Date(base.getFullYear(), base.getMonth(), base.getDate()).getTime(),
    MS_Start: hhmmToMs(base, $("#fTimeStart").value),
    MS_End:   hhmmToMs(base, $("#fTimeEnd").value),
    MS_Status: $("#fStatus").value || "Planned",
    MS_Description: ($("#fDesc").value||"").trim(),
    MS_Technicians: state.technicians.join(", "),
    MS_Task: ($("#fTasks").value||"").trim()
  };
}
function validatePayload(p){
  var must = [
    ["Title", p.MS_Title],
    ["Machine (MC_01/02/03)", p.MS_Machine],
    ["At least one technician", p.MS_Technicians]
  ];
  for (var i=0;i<must.length;i++){ if(!must[i][1]) return "Please enter "+must[i][0]; }
  if (!/^MC_0[1-3]$/.test(p.MS_Machine)) return "Please pick a valid Machine (MC_01 / MC_02 / MC_03).";
  if (p.MS_End <= p.MS_Start) return "End time must be after Start time.";
  return "";
}
function onCreate(){
  var payload = collectPayload();
  var err = validatePayload(payload); if (err){ alert(err); return; }
  loading("Saving‚Ä¶"); busy(true);
  writeAttributes(payload, { mode:"create" })
    .then(function(){
      closeOverlay();
      startAutoRefresh(payload.MS_Start, null);
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to save"); })
    .finally(function(){ busy(false); });
}
function onUpdate(){
  if(!state.selectedEvent || !state.selectedEvent.extendedProps){ alert("No task selected for update."); return; }
  var payload = collectPayload();
  var baseTs = state.selectedEvent.extendedProps.__ts;
  if(!baseTs){ alert("Missing base timestamp for update. Please reselect the task."); return; }
  payload[ATTR_MS_UPD_TS] = baseTs;

  var err = validatePayload(payload); if (err){ alert(err); return; }

  loading("Updating‚Ä¶"); busy(true);
  writeAttributes(payload, { mode:"update" })
    .then(function(){
      closeOverlay();
      startAutoRefresh(payload[ATTR_MS_UPD_TS], function(found){
        var p = found.extendedProps || {};
        var titleOk = String(p.MS_Title||"") === String(payload.MS_Title||"");
        var machOk  = String(p.MS_Machine||"") === String(payload.MS_Machine||"");
        var typeOk  = String(p.MS_Type||"") === String(payload.MS_Type||"");
        var priOk   = String(p.MS_Priority) === String(payload.MS_Priority);
        var stOk    = String(p.MS_Status||"") === String(payload.MS_Status||"");
        var sOk     = Number(p.MS_Start||0) === Number(payload.MS_Start||0);
        var eOk     = Number(p.MS_End||0)   === Number(payload.MS_End||0);
        var techOk  = String(p.MS_Technicians||"") === String(payload.MS_Technicians||"");
        var taskOk  = String(p.MS_Task||"") === String(payload.MS_Task||"");
        return titleOk && machOk && typeOk && priOk && stOk && sOk && eOk && techOk && taskOk;
      });
    })
    .catch(function(e){ console.error(e); alert(e.message||"Failed to update"); })
    .finally(function(){ busy(false); });
}

/************ PDF (Download) ************/
$("#btnPDF").addEventListener("click", function(){
  if (!state.selectedEvent){ alert("Select a task first."); return; }
  generatePdf(state.selectedEvent);
});

function generatePdf(ev){
  var p = ev.extendedProps;
  var idTs = String(p.__ts || ev.start?.getTime() || Date.now());
  var reportNo = idTs;
  var genOn = new Date().toLocaleString();
  var schDate = p.MS_Date ? new Date(Number(p.MS_Date)) : new Date(p.MS_Start);
  var durMin = Math.max(0, Math.round((Number(p.MS_End) - Number(p.MS_Start))/60000));
  var durHr = Math.floor(durMin/60), remMin = durMin%60;
  var durationText = (durHr?durHr+"h ":"") + remMin + "m";
  var tasks = String(p.MS_Task||"").split(",").map(s=>s.trim()).filter(Boolean);

  var root = document.createElement("div");
  root.className = "r-wrap";
  root.innerHTML = `
    <div class="r-head">
      <div class="logos"><img src="./PlantwizLogo.png" onerror="this.style.display='none'"></div>
      <div class="r-title">
        <h1>Pima Controls Pvt. Ltd</h1>
        <div class="addr">Block No.298, Nr. Bacha Motors, Sanathal Cross Road, Ahmedabad (382210)</div>
      </div>
      <div class="logos"><img src="./PimaLogo.png" onerror="this.style.display='none'"></div>
    </div>

    <div style="display:flex;justify-content:space-between;margin:-6px 0 8px 0;font-size:11px;color:#374151;">
      <div></div>
      <div class="r-meta">
        <div><strong>Report No:</strong> ${escapeHtml(reportNo)}</div>
        <div><strong>Generated:</strong> ${escapeHtml(genOn)}</div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Maintenance Task Report</div>
      <div class="r-grid">
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Title</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Title||"-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Machine / Asset</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Machine||"-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Type</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Type||"-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Priority</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(String(p.MS_Priority??"-"))}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Status</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Status||"-")}</td></tr>
          </table>
        </div>
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Scheduled Date</strong></td><td style="border:0;padding:2px 0;">${schDate.toLocaleDateString()}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Start</strong></td><td style="border:0;padding:2px 0;">${msToHHMM(p.MS_Start)}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>End</strong></td><td style="border:0;padding:2px 0;">${msToHHMM(p.MS_End)}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Duration</strong></td><td style="border:0;padding:2px 0;">${durationText}</td></tr>
          </table>
        </div>
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Technicians</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Technicians||"-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Report ID TS</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(reportNo)}</td></tr>
          </table>
        </div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Description / Notes</div>
      <div class="r-row">
        <div class="box" style="grid-column:1/-1;">${escapeHtml(p.MS_Description||"-")}</div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Checklist</div>
      <div style="padding:10px;">
        <table class="r-table">
          <thead>
            <tr>
              <th style="width:32px;">#</th>
              <th>Task Item</th>
              <th style="width:56px;">Done</th>
              <th>Remarks</th>
              <th style="width:120px;">Checked By</th>
              <th style="width:96px;">Time</th>
            </tr>
          </thead>
          <tbody>
            ${ (tasks.length?tasks:["‚Äî"]).map((t,i)=>`
              <tr>
                <td>${i+1}</td>
                <td>${escapeHtml(String(t))}</td>
                <td>‚òê</td>
                <td></td>
                <td></td>
                <td></td>
              </tr>`).join('') }
          </tbody>
        </table>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Approvals</div>
      <div class="r-foot">
        <div class="sign">
          <strong>Technician Sign & Date</strong>
        </div>
        <div class="sign">
          <strong>Supervisor Sign & Date</strong>
        </div>
      </div>
    </div>

    <div class="r-fine">
      <span>Generated by Maintenance Scheduler</span>
      <span>Page 1 / 1</span>
    </div>
  `;

  var pdfRoot = $("#pdfRoot");
  pdfRoot.innerHTML = "";
  pdfRoot.appendChild(root);

  const opt = {
    margin:       [10,10,10,10],
    filename:     (p.MS_Title ? p.MS_Title.replace(/\s+/g,'_') : 'Maintenance_Task') + "_" + reportNo + ".pdf",
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true, background: '#ffffff' },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css','legacy'] }
  };
  html2pdf().from(root).set(opt).save();
}

/************ PREVENTIVE TIPS (Runtime + Coverage) ************/
/* Utility: group by machine, month counts */
function countSchedulesForMonth(events, monthDate){
  var s = startOfMonth(monthDate).getTime(), e = endOfMonth(monthDate).getTime();
  var perMachine = {};
  events.forEach(ev=>{
    var p = ev.extendedProps||{};
    if (ev.start.getTime()>=s && ev.start.getTime()<=e &&
        (p.MS_Status==="Planned" || p.MS_Status==="Completed")){
      var m = normMachine(p.MS_Machine||"");
      if (!m) return;
      perMachine[m] = (perMachine[m]||0)+1;
    }
  });
  return perMachine;
}

/* Find last completed maintenance ts per machine */
function lastCompletedTsByMachine(events){
  var map = {};
  events.forEach(ev=>{
    var p = ev.extendedProps||{};
    if (String(p.MS_Status).toLowerCase()==="completed"){
      var m = normMachine(p.MS_Machine||"");
      if (!m) return;
      var t = Number(p.MS_End || p.MS_Start || ev.start?.getTime() || 0);
      if (!map[m] || t>map[m]) map[m]=t;
    }
  });
  return map;
}

/* Telemetry read with chunking to avoid 50k limit errors */
async function readRuntimeTelemetry(key, startMs, endMs, limit){
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(key) +
            "&startTs=" + startMs +
            "&endTs="   + endMs +
            "&limit="   + (limit||10000);
  const res = await fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } });
  if (!res.ok){
    const txt = await res.text();
    throw new Error("Runtime read failed: " + txt);
  }
  return res.json();
}

/* For a range, get per-day latest value (minutes), then sum (minutes) => return hours */
async function fetchRuntimeHoursSince(key, fromMs){
  const today = new Date();
  const endMs = endOfDay(today).getTime();

  // Split by month to keep results under server limit
  let cursor = new Date(fromMs);
  cursor = startOfDay(cursor);
  let hoursTotal = 0;
  let infoDaily = []; // for UI debug

  while (cursor.getTime() <= endMs){
    const chunkStart = new Date(cursor.getFullYear(), cursor.getMonth(), 1).getTime();
    const chunkEnd   = new Date(cursor.getFullYear(), cursor.getMonth()+1, 0, 23,59,59,999).getTime();
    const s = Math.max(fromMs, chunkStart);
    const e = Math.min(endMs, chunkEnd);

    // If window is in the future (shouldn't), break
    if (s > e) break;

    let data;
    try{
      // Start with a higher limit; if server complains, fall back smaller windows
      data = await readRuntimeTelemetry(key, s, e, 40000);
    }catch(err){
      // try smaller limit / smaller window (weekly)
      const weekHours = await fetchRuntimeHoursWeekly(key, s, e);
      hoursTotal += weekHours.totalHours;
      infoDaily.push(...weekHours.daily);
      cursor = new Date(chunkEnd + 1);
      continue;
    }

    const arr = data && data[key] ? data[key] : [];
    // group by day ‚Üí pick latest value per day
    const perDay = new Map();
    arr.forEach(pt=>{
      const d = new Date(Number(pt.ts));
      const ds = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
      const prev = perDay.get(ds);
      if (!prev || Number(pt.ts) > prev.ts) perDay.set(ds, { ts:Number(pt.ts), val:Number(pt.value)||0 });
    });
    perDay.forEach((v, ds)=>{
      infoDaily.push({ day: new Date(ds), minutes: v.val });
      hoursTotal += (v.val / 60);
    });

    cursor = new Date(chunkEnd + 1);
  }

  return { hoursTotal, infoDaily };
}

async function fetchRuntimeHoursWeekly(key, startMs, endMs){
  let s = startMs;
  let hoursTotal = 0;
  let daily = [];
  while (s <= endMs){
    const e = Math.min(endMs, s + 6*24*60*60*1000 + (24*60*60*1000-1)); // up to 7 days
    const data = await readRuntimeTelemetry(key, s, e, 10000);
    const arr = data && data[key] ? data[key] : [];
    const perDay = new Map();
    arr.forEach(pt=>{
      const d = new Date(Number(pt.ts));
      const ds = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
      const prev = perDay.get(ds);
      if (!prev || Number(pt.ts) > prev.ts) perDay.set(ds, { ts:Number(pt.ts), val:Number(pt.value)||0 });
    });
    perDay.forEach((v, ds)=>{
      daily.push({ day: new Date(ds), minutes: v.val });
      hoursTotal += (v.val / 60);
    });
    s = e + 1;
  }
  return { totalHours: hoursTotal, daily };
}

/* Render Tips */
async function renderTips(){
  // Base events ‚Äî we use the current calendar month‚Äôs events to compute coverage
  const baseDate = state.calendar ? state.calendar.getDate() : new Date();
  const monthStart = startOfMonth(baseDate), monthEnd = endOfMonth(baseDate);

  loading("Loading tips‚Ä¶");
  let events;
  try{
    events = await readRange(monthStart, monthEnd);
  }catch(err){
    console.error(err);
    $("#tipsGrid").innerHTML = '<div class="empty">Failed to load events for tips.</div>';
    $("#tipsRuntimeInfo").textContent = "";
    loading("Failed to load");
    return;
  }

  // Keep filters consistent with other views
  populateFilters(events);
  state.lastEventsFull = events.slice();

  // === Preventive coverage tip (per machine, current month planned + completed)
  const perMachineCount = countSchedulesForMonth(events, baseDate);

  // === Runtime tip (since last completed) ‚Äî only MC_01 supported now
  const lastDone = lastCompletedTsByMachine(events); // by machine, within this month (we also fallback earlier)
  // If not found in this month, we need to look back a bit to find last completed:
  // Search back 90 days quickly
  async function ensureLastCompleted(machine){
    if (lastDone[machine]) return lastDone[machine];
    const backStart = new Date(); backStart.setDate(backStart.getDate()-90);
    try{
      const older = await readRange(backStart, new Date());
      const olderMap = lastCompletedTsByMachine(older);
      return olderMap[machine] || null;
    }catch(e){ return null; }
  }

  const tips = [];

  // Coverage tips for MC_01/02/03 (requirement: at least 2 schedules in the month)
  ["MC_01","MC_02","MC_03"].forEach(m=>{
    const cnt = perMachineCount[m] || 0;
    if (cnt < 2){
      tips.push({
        kind:"coverage",
        machine:m,
        state:"warn",
        title:`Preventive coverage low for ${m}`,
        body:`Current month has ${cnt} preventive schedule(s). Tip: maintain at least <strong>2</strong> preventive schedules for ${m} this month.`,
      });
    } else {
      tips.push({
        kind:"coverage",
        machine:m,
        state:"ok",
        title:`Preventive coverage OK for ${m}`,
        body:`${cnt} preventive schedule(s) planned/completed this month.`,
      });
    }
  });

  // Runtime tip only for MC_01 (as of now)
  let runtimeInfoText = "";
  try{
    const m = "MC_01";
    const key = RUNTIME_KEYS[m];
    if (key){
      const lastTs = await ensureLastCompleted(m);
      const fromMs = lastTs || (new Date().setDate(new Date().getDate()-30)); // fallback to last 30 days
      const { hoursTotal, infoDaily } = await fetchRuntimeHoursSince(key, fromMs);

      runtimeInfoText =
        `Runtime since last Completed for ${m}: `+
        `<strong>${hoursTotal.toFixed(1)} h</strong> (based on per-day latest values of <em>${key}</em>)`;

      if (hoursTotal > 400){
        tips.push({
          kind:"runtime",
          machine:m,
          state:"bad",
          title:`${m} runtime crossed 400h`,
          body:`Runtime since last completion is <strong>${hoursTotal.toFixed(1)} h</strong>. Please schedule maintenance.`,
        });
      } else {
        tips.push({
          kind:"runtime",
          machine:m,
          state:"ok",
          title:`${m} runtime in control`,
          body:`Runtime since last completion is ${hoursTotal.toFixed(1)} h (threshold 400 h).`,
        });
      }
    } else {
      runtimeInfoText = "Runtime tip is currently enabled for MC_01 only.";
    }
  }catch(err){
    console.error("Runtime tips error:", err);
    runtimeInfoText = "Runtime data unavailable (telemetry read error).";
  }

  // Render tips grid
  const grid = $("#tipsGrid");
  if (!tips.length){
    grid.innerHTML = '<div class="empty">No tips to show.</div>';
  } else {
    grid.innerHTML = tips.map(t=>{
      const tone = t.state==="bad"?"tip-bad":t.state==="warn"?"tip-warn":"tip-ok";
      return `
        <div class="tip-card">
          <header>
            <span class="tip-title">${escapeHtml(t.title)}</span>
            <span class="${tone}">‚óè</span>
          </header>
          <div class="tip-body">
            <div>${t.body}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // Show runtime info ONLY in tips section (as requested)
  $("#tipsRuntimeInfo").innerHTML = runtimeInfoText;

  loading("Tips ready");
}

/************ BOOT (Calendar) ************/
function startCalendar(){
  if (!window.FullCalendar){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>'; return;
  }
  if (!JWT){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">Missing JWT (?token=‚Ä¶)</span></div>'; return;
  }
  var calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    height: "auto",
    eventContent: eventContent,
    dateClick: function(info){ openModalForDate(info.date); },
    eventClick: function(info){ showDetails(info.event); },
    datesSet: function(info){
      state.lastRange = { start: info.start, end: info.end };
      readRange(info.start, info.end)
        .then(function(events){
          state.lastEventsFull = events.slice();
          populateFilters(events);
          if (state.view==="calendar"){
            refreshCalendar();
            $("#details").className="empty"; $("#details").textContent="Select a task";
            $("#sideActions").style.display="none";
          }
        })
        .catch(function(err){
          console.error(err); loading(err.message || "Failed to load");
          if (state.calendar) state.calendar.removeAllEvents();
        });
    }
  });
  state.calendar.render();

  // Legends on toolbar right (calendar only)
  const toolbar = calEl.querySelector(".fc-toolbar-chunk:nth-child(3)");
  if (toolbar){
    const legends = document.createElement("div");
    legends.className = "fc-toolbar-chunk legends";
    legends.innerHTML = `
      <span><span class="legend-box legend-planned"></span> Planned</span>
      <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
      <span><span class="legend-box legend-completed"></span> Completed</span>
      <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
      <span><span class="legend-box legend-postponed"></span> Postponed</span>
    `;
    toolbar.appendChild(legends);
  }
}
if (document.readyState==="complete" || document.readyState==="interactive") setTimeout(startCalendar,0);
else document.addEventListener("DOMContentLoaded", startCalendar);
</script>
</body>
</html>
