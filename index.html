<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--cyan:#06b6d4;--amber:#f59e0b;--red:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .spacer{flex:1}
  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  #loading{font-size:12px;color:#64748b;margin-left:8px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Maintenance details</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn ghost"   id="btnNew"    type="button">New</button>
      <button class="btn primary" id="btnEdit"   type="button">Update</button>
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add maintenance task</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div>
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Weekly lubrication">
      </div>
      <div>
        <label>Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02">
      </div>

      <div>
        <label>Type</label>
        <select id="fType" class="input">
          <option>Preventive</option>
          <option>Predictive</option>
          <option>Breakdown</option>
          <option>Calibration</option>
          <option>Inspection</option>
        </select>
      </div>
      <div>
        <label>Priority</label>
        <select id="fPriority" class="input">
          <option>Low</option><option selected>Medium</option><option>High</option><option>Urgent</option>
        </select>
      </div>

      <div>
        <label>Time From</label>
        <input id="fTimeFrom" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>Time To</label>
        <input id="fTimeTo" class="input" type="time" value="11:00">
      </div>

      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option>
          <option>In-Progress</option>
          <option>Completed</option>
          <option>Cancelled</option>
        </select>
      </div>
      <div>
        <label>Technicians</label>
        <input id="fTechs" class="input" type="text" placeholder="comma-separated e.g., Jatin, Vimal">
      </div>

      <div class="row-full">
        <label>Description</label>
        <textarea id="fDesc" class="input" rows="2" placeholder="Optional notes"></textarea>
      </div>

      <!-- Tasks (chips -> stored as comma-separated MS_Task) -->
      <div class="row-full">
        <label>Tasks / Checklist</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="taskOne" class="input" type="text" placeholder="Type a task and click +">
          <button class="btn ghost" id="addTaskBtn" type="button">+</button>
        </div>
        <div id="taskChips" class="chips"></div>
        <div class="muted" style="font-size:12px;margin-top:6px">These are saved in <code>MS_Task</code> (comma-separated).</div>
      </div>

      <div class="row-full muted" id="fDateHint">Date: â€”</div>
    </div>
    <footer>
      <button class="btn primary" id="saveSession" type="button">Save</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

// Telemetry keys for Maintenance
var KEYS = [
  "MS_Title","MS_Machine","MS_Type","MS_Priority",
  "MS_Date","MS_Start","MS_End","MS_Status",
  "MS_Description","MS_Technicians","MS_Task"
];

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
function escapeHtml(s){
  return String(s||"").replace(/[&<>\"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
}
function midnightMs(yyyy_mm_dd){
  // yyyy-mm-dd -> local midnight ms
  var parts = String(yyyy_mm_dd).split("-");
  var d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]), 0,0,0,0);
  return d.getTime();
}
function mergeDateTime(baseDate, hhmm){
  var parts = String(hhmm||"00:00").split(":");
  var h = parseInt(parts[0]||"0",10), m = parseInt(parts[1]||"0",10);
  var d = new Date(baseDate); d.setHours(h||0, m||0, 0, 0);
  return d.getTime();
}
function msToHHMM(ms){
  var d = new Date(ms);
  return String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
}
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="completed") return "status-completed";
  if (v==="in-progress" || v==="inprogress") return "status-inprogress";
  return "status-planned";
}
function fmtTime(ms){
  var d = new Date(ms), h = d.getHours()%12 || 12;
  var ampm = d.getHours()>=12 ? "PM":"AM";
  return String(h).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+" "+ampm;
}

var state = {
  calendar:null, clickedDate:null, lastRange:null, selectedEvent:null, mode:"create",
  taskList:[]
};

/************ READ (FIXED) ************/
function readRange(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
            + "?keys=" + encodeURIComponent(KEYS.join(","))
            + "&startTs=" + rangeStart.getTime()
            + "&endTs="   + rangeEnd.getTime()
            + "&limit=5000";

  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json()
                        : res.text().then(t => { throw new Error("Timeseries read failed: " + t); }))
    .then(tsObj => {
      const map = {};
      Object.keys(tsObj||{}).forEach(k=>{
        (tsObj[k]||[]).forEach(p=>{
          const ts = Number(p.ts);
          const rec = map[ts] || (map[ts] = { ts });
          rec[k] = p.value;
        });
      });
      const out = [];
      Object.keys(map).forEach(tsStr=>{
        const r = map[tsStr];
        const st = Number(r.MS_Start || r.ts);
        const en = Number(r.MS_End || (st + 60*60*1000));
        const title = String(r.MS_Title || "Maintenance");
        out.push({
          id: "ts-"+r.ts,
          title,
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.MS_Status)],
          extendedProps: {
            MS_Title: r.MS_Title || "",
            MS_Machine: r.MS_Machine || "",
            MS_Type: r.MS_Type || "",
            MS_Priority: r.MS_Priority || "",
            MS_Date: Number(r.MS_Date || midnightMs(new Date(st).toISOString().slice(0,10))),
            MS_Start: st, MS_End: en,
            MS_Status: r.MS_Status || "Planned",
            MS_Description: r.MS_Description || "",
            MS_Technicians: r.MS_Technicians || "",
            MS_Task: r.MS_Task || "",
            __ts: r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ EVENT RENDER ************/
function eventContent(arg){
  const p = arg.event.extendedProps;
  const time = fmtTime(p.MS_Start);
  const title = p.MS_Title || "Maintenance";
  return { html: '<span>'+escapeHtml(time)+' â€” '+escapeHtml(title)+'</span>' };
}

/************ WRITE ************/
function writeAttributes(payload){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";
  const body = {
    MS_Title: payload.MS_Title || "",
    MS_Machine: payload.MS_Machine || "",
    MS_Type: payload.MS_Type || "",
    MS_Priority: payload.MS_Priority || "",
    MS_Date: payload.MS_Date,
    MS_Start: payload.MS_Start,
    MS_End: payload.MS_End,
    MS_Status: payload.MS_Status || "Planned",
    MS_Description: payload.MS_Description || "",
    MS_Technicians: payload.MS_Technicians || "",
    MS_Task: payload.MS_Task || ""
  };
  return fetch(url, {
    method: "POST",
    headers: { "X-Authorization": "Bearer " + JWT, "Content-Type": "application/json" },
    body: JSON.stringify(body)
  }).then(res => res.ok ? null : res.text().then(t => { throw new Error("Attribute write failed: " + t); }));
}

/************ DETAILS ************/
function showDetails(ev){
  state.selectedEvent = ev;
  const p = ev.extendedProps;
  const tasks = (p.MS_Task||"").split(",").map(s=>s.trim()).filter(Boolean);
  function fmt(v){ return v ? new Date(Number(v)).toLocaleString() : "-"; }

  $("#details").className = "";
  $("#details").innerHTML =
    '<div class="kpi">'+
      '<span>Title</span><span>'+escapeHtml(p.MS_Title||"-")+'</span>'+
      '<span>Machine</span><span>'+escapeHtml(p.MS_Machine||"-")+'</span>'+
      '<span>Type</span><span>'+escapeHtml(p.MS_Type||"-")+'</span>'+
      '<span>Priority</span><span>'+escapeHtml(p.MS_Priority||"-")+'</span>'+
      '<span>Status</span><span>'+escapeHtml(p.MS_Status||"Planned")+'</span>'+
      '<span>Date</span><span>'+fmt(p.MS_Date)+'</span>'+
      '<span>Start</span><span>'+fmt(p.MS_Start)+'</span>'+
      '<span>End</span><span>'+fmt(p.MS_End)+'</span>'+
      '<span>Technicians</span><span>'+escapeHtml(p.MS_Technicians||"-")+'</span>'+
      '<span>Description</span><span>'+escapeHtml(p.MS_Description||"-")+'</span>'+
      '<span>Tasks</span><span>'+ (tasks.length?('<ul style="margin:6px 0;padding-left:18px">'+tasks.map(t=>'<li>'+escapeHtml(t)+'</li>').join('')+'</ul>'):'-') +'</span>'+
    '</div>';
  $("#sideActions").style.display = "flex";
}

/************ MODAL + TASK CHIPS ************/
var overlay = $("#overlay");
function busy(on){ ["saveSession","btnCancel","btnEdit","btnNew"].forEach(id=>{ var el=$("#"+id); if(el) el.disabled=!!on; }); }

function refreshTaskChips(){
  const box = $("#taskChips"); box.innerHTML="";
  state.taskList.forEach((t,idx)=>{
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = '<span>'+escapeHtml(t)+'</span><button type="button" aria-label="Remove">âœ•</button>';
    chip.querySelector("button").addEventListener("click", ()=>{ state.taskList.splice(idx,1); refreshTaskChips(); });
    box.appendChild(chip);
  });
}
function addOneTask(){
  const v = ($("#taskOne").value||"").trim();
  if(!v) return;
  state.taskList.push(v);
  $("#taskOne").value="";
  refreshTaskChips();
}
$("#addTaskBtn").addEventListener("click", addOneTask);
$("#taskOne").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addOneTask(); } });

$("#closeModal").addEventListener("click", function(){ overlay.style.display="none"; });
$("#btnNew").addEventListener("click", function(){ openModalForDate(new Date()); });

$("#saveSession").addEventListener("click", function(){
  if (state.mode === "update") onUpdate();
  else onCreate();
});

$("#btnEdit").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  const p = state.selectedEvent.extendedProps;

  state.mode="update";
  $("#modalTitle").textContent="Update maintenance task";
  $("#saveSession").textContent="Update";

  const base = new Date(p.MS_Date || p.MS_Start);
  state.clickedDate = new Date(base.getFullYear(), base.getMonth(), base.getDate());

  $("#fTitle").value     = p.MS_Title || "";
  $("#fMachine").value   = p.MS_Machine || "";
  $("#fType").value      = p.MS_Type || "Preventive";
  $("#fPriority").value  = p.MS_Priority || "Medium";
  $("#fTimeFrom").value  = msToHHMM(p.MS_Start);
  $("#fTimeTo").value    = msToHHMM(p.MS_End);
  $("#fStatus").value    = p.MS_Status || "Planned";
  $("#fTechs").value     = p.MS_Technicians || "";
  $("#fDesc").value      = p.MS_Description || "";
  state.taskList         = (p.MS_Task||"").split(",").map(s=>s.trim()).filter(Boolean);
  refreshTaskChips();

  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();
  overlay.style.display="flex";
});

$("#btnCancel").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  if(!confirm("Cancel this maintenance task?")) return;

  const p = state.selectedEvent.extendedProps;
  const payload = {
    MS_Title: p.MS_Title, MS_Machine: p.MS_Machine, MS_Type: p.MS_Type, MS_Priority: p.MS_Priority,
    MS_Date: p.MS_Date, MS_Start: p.MS_Start, MS_End: p.MS_End,
    MS_Status: "Cancelled",
    MS_Description: p.MS_Description, MS_Technicians: p.MS_Technicians, MS_Task: p.MS_Task
  };

  loading("Cancellingâ€¦"); busy(true);
  writeAttributes(payload)
    .then(()=>{ // simple reload after cancel
      if(state.lastRange){
        return readRange(state.lastRange.start, state.lastRange.end).then(events=>{
          state.calendar.removeAllEvents(); state.calendar.addEventSource(events);
          $("#details").className="empty"; $("#details").textContent="Select a task on the calendar";
          $("#sideActions").style.display="none"; loading("Loaded "+events.length+" task(s)");
        });
      }
    })
    .catch(e=>{ console.error(e); alert(e.message||"Failed to cancel"); })
    .finally(()=>busy(false));
});

/************ CREATE / UPDATE ************/
function openModalForDate(jsDate){
  state.mode="create";
  state.clickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());
  $("#modalTitle").textContent="Add maintenance task";
  $("#saveSession").textContent="Save";
  $("#fDateHint").textContent = "Date: " + state.clickedDate.toDateString();

  $("#fTitle").value=""; $("#fMachine").value="";
  $("#fType").value="Preventive"; $("#fPriority").value="Medium";
  $("#fTimeFrom").value="09:00"; $("#fTimeTo").value="11:00";
  $("#fStatus").value="Planned"; $("#fTechs").value=""; $("#fDesc").value="";
  state.taskList=[]; refreshTaskChips();

  overlay.style.display="flex";
}
function collectPayload(base){
  return {
    MS_Title: ($("#fTitle").value||"").trim(),
    MS_Machine: ($("#fMachine").value||"").trim(),
    MS_Type: $("#fType").value||"Preventive",
    MS_Priority: $("#fPriority").value||"Medium",
    MS_Date: midnightMs(base.getFullYear()+"-"+String(base.getMonth()+1).padStart(2,"0")+"-"+String(base.getDate()).padStart(2,"0")),
    MS_Start: mergeDateTime(base, $("#fTimeFrom").value),
    MS_End:   mergeDateTime(base, $("#fTimeTo").value),
    MS_Status: $("#fStatus").value||"Planned",
    MS_Description: ($("#fDesc").value||"").trim(),
    MS_Technicians: ($("#fTechs").value||"").trim(),
    MS_Task: state.taskList.join(", ")
  };
}
function validatePayload(p){
  const must = [
    ["Title", p.MS_Title],
    ["Machine", p.MS_Machine]
  ];
  for (let i=0;i<must.length;i++){ if(!must[i][1]) return "Please enter "+must[i][0]; }
  if (p.MS_End <= p.MS_Start) return "Time To must be after Time From.";
  return "";
}
function onCreate(){
  const base = state.clickedDate || new Date();
  const payload = collectPayload(base);
  const err = validatePayload(payload); if(err){ alert(err); return; }

  loading("Savingâ€¦"); busy(true);
  writeAttributes(payload)
    .then(()=>{ overlay.style.display="none";
      if(state.lastRange){
        return readRange(state.lastRange.start, state.lastRange.end).then(events=>{
          state.calendar.removeAllEvents(); state.calendar.addEventSource(events);
          loading("Loaded "+events.length+" task(s)");
        });
      }
    })
    .catch(e=>{ console.error(e); alert(e.message||"Failed to save"); })
    .finally(()=>busy(false));
}
function onUpdate(){
  if(!state.selectedEvent){ alert("No task selected for update."); return; }
  const base = state.clickedDate || new Date();
  const payload = collectPayload(base);
  const err = validatePayload(payload); if(err){ alert(err); return; }

  loading("Updatingâ€¦"); busy(true);
  writeAttributes(payload)
    .then(()=>{ overlay.style.display="none";
      if(state.lastRange){
        return readRange(state.lastRange.start, state.lastRange.end).then(events=>{
          state.calendar.removeAllEvents(); state.calendar.addEventSource(events);
          loading("Loaded "+events.length+" task(s)");
        });
      }
    })
    .catch(e=>{ console.error(e); alert(e.message||"Failed to update"); })
    .finally(()=>busy(false));
}

/************ BOOT ************/
function startCalendar(){
  if (!window.FullCalendar){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>';
    return;
  }
  if (!JWT){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">Missing JWT (?token=â€¦)</span></div>';
    return;
  }
  var calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    height: "auto",
    eventContent: eventContent,
    dateClick: function(info){ openModalForDate(info.date); },
    eventClick: function(info){ showDetails(info.event); },
    datesSet: function(info){
      loading("Loadingâ€¦");
      state.lastRange = { start: info.start, end: info.end };
      readRange(info.start, info.end)
        .then(function(events){
          state.calendar.removeAllEvents();
          state.calendar.addEventSource(events);
          $("#details").className="empty"; $("#details").textContent="Select a task on the calendar";
          $("#sideActions").style.display="none";
          loading("Loaded "+events.length+" task(s)");
        })
        .catch(function(err){
          console.error(err); loading(err.message || "Failed to load");
          state.calendar.removeAllEvents();
        });
    }
  });
  state.calendar.render();
  loading("");
}
if (document.readyState === "complete" || document.readyState === "interactive") setTimeout(startCalendar,0);
else document.addEventListener("DOMContentLoaded", startCalendar);
</script>
</body>
</html>
