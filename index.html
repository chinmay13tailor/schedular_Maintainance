<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--cyan:#06b6d4;--amber:#f59e0b;--red:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:1fr 320px;gap:16px;min-height:100vh;padding:16px}
  header{grid-column:1/-1;display:flex;gap:10px;align-items:center;border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px}
  .spacer{flex:1}
  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #calendar{min-height:560px}
  .side{border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;position:sticky;top:16px;height:fit-content}
  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .muted{color:#64748b}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(640px,92vw);background:#fff;border:1px solid var(--ring);border-radius:14px;box-shadow:0 24px 48px rgba(0,0,0,.18)}
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}

  /* Tabs inside modal */
  .tabs{display:flex;border-bottom:1px solid var(--ring);gap:6px;padding:0 12px}
  .tab-btn{border:0;background:transparent;padding:10px 8px;cursor:pointer;font-weight:800;color:#475569}
  .tab-btn.active{color:#0f172a;border-bottom:2px solid #0f172a}
  .tab-pane{display:none;padding:14px;gap:10px;grid-template-columns:1fr 1fr}
  .tab-pane.active{display:grid}
  .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}

  /* chips (for technicians & tasks) */
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}
  .row-inline{display:flex;gap:8px;align-items:center}

  /* Event coloring */
  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <div class="card"><div id="calendar"></div></div>

  <aside class="side">
    <h3 class="h6">Maintenance details</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add maintenance</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-details">Details</button>
      <button class="tab-btn" data-tab="tab-tasks">Tasks</button>
    </div>

    <!-- Tab panes -->
    <div id="tab-details" class="tab-pane active">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Preventive – Spindle lubrication">
      </div>
      <div>
        <label>Machine</label>
        <input id="fMachine" class="input" type="text" placeholder="e.g., LATHE-02">
      </div>
      <div>
        <label>Type</label>
        <select id="fType" class="input">
          <option>Preventive</option><option>Corrective</option><option>Calibration</option>
          <option>Inspection</option><option>Others</option>
        </select>
      </div>
      <div>
        <label>Priority (1–5)</label>
        <select id="fPriority" class="input">
          <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option><option>In-Progress</option><option>Completed</option>
          <option>Cancelled</option><option>Postponed</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input id="fDate" class="input" type="date">
      </div>
      <div>
        <label>Start</label>
        <input id="fStart" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>End</label>
        <input id="fEnd" class="input" type="time" value="11:00">
      </div>
      <div class="row-full">
        <label>Description</label>
        <textarea id="fDesc" class="input" rows="2" placeholder="Short notes"></textarea>
      </div>

      <div class="row-full">
        <label>Technician(s)</label>
        <div class="row-inline">
          <input id="techOne" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addTechBtn" type="button">+</button>
        </div>
        <div id="techChips" class="chips"></div>
      </div>
    </div>

    <div id="tab-tasks" class="tab-pane">
      <div class="row-full">
        <label>Task point</label>
        <div class="row-inline">
          <input id="taskOne" class="input" type="text" placeholder="e.g., Check oil level">
          <button class="btn ghost" id="addTaskBtn" type="button">+</button>
        </div>
        <div id="taskChips" class="chips"></div>
        <div class="muted" style="margin-top:6px">These will be saved to <code>MS_Task</code> as a comma-separated list.</div>
      </div>
      <div class="row-full">
        <label>Bulk add (optional)</label>
        <textarea id="taskBulk" class="input" rows="3" placeholder="Paste multiple lines; we’ll split to tasks"></textarea>
        <div class="row-inline" style="margin-top:6px">
          <button class="btn" id="btnBulkToChips" type="button">Add all as tasks</button>
          <span class="muted">Duplicates are ignored.</span>
        </div>
      </div>
    </div>

    <footer>
      <button class="btn primary" id="saveBtn" type="button">Save</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "991cf500-661a-11f0-90f1-775fee303094";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

/* Rule-chain flags */
var ATTR_MS_SAVE_FLAG   = "MS_Save_Button";       // false on create
var ATTR_MS_UPDATE_FLAG = "MS_Update_Buttton";    // true on update/cancel (intentional spelling)
var ATTR_MS_UPDATE_TS   = "MS_Update_Timestamp";  // base ts to rewrite

/* Telemetry keys (read) */
var KEYS = [
  "MS_Title","MS_Machine","MS_Type","MS_Priority","MS_Date","MS_Start","MS_End",
  "MS_Status","MS_Description","MS_Technicians","MS_Task"
];

/************ STATE & HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
var state = {
  calendar:null, lastRange:null, selectedEvent:null, mode:"create",
  techs:[], tasks:[]
};
function mergeDateAndTime(dateStr, hhmm){
  // dateStr: "YYYY-MM-DD" (local), hhmm: "HH:MM"
  var d = new Date(dateStr+"T00:00:00");
  var parts = String(hhmm||"00:00").split(":");
  d.setHours(parseInt(parts[0]||"0",10), parseInt(parts[1]||"0",10), 0, 0);
  return d.getTime();
}
function midnightMs(dateStr){
  var d = new Date(dateStr+"T00:00:00"); d.setHours(0,0,0,0); return d.getTime();
}
function msToHHMM(ms){ var d=new Date(ms); return String(d.getHours()).padStart(2,'0')+":"+String(d.getMinutes()).padStart(2,'0'); }
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="in-progress" || v==="inprogress") return "status-inprogress";
  if (v==="completed") return "status-completed";
  return "status-planned";
}
function eventContent(arg){
  const p = arg.event.extendedProps;
  const d = new Date(p.MS_Start), hr=d.getHours()%12||12, am=d.getHours()>=12?"PM":"AM";
  const time = String(hr).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+" "+am;
  const title = p.MS_Title || "Maintenance";
  return { html: '<span>'+time+' — '+title+'</span>' };
}

/************ READ ************/
function readRange(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(",")) +
            "&startTs=" + rangeStart.getTime() +
            "&endTs="   + rangeEnd.getTime() +
            "&limit=5000";
  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: "+t); })))
    .then(tsObj => {
      const map = {};
      Object.keys(tsObj||{}).forEach(k=>{
        (tsObj[k]||[]).forEach(p=>{
          const ts=Number(p.ts);
          const rec = map[ts] || (map[ts]={ts});
          rec[k] = p.value;
        });
      });
      const out=[];
      Object.keys(map).forEach(tsStr=>{
        const r = map[tsStr];
        const st = Number(r.MS_Start||r.ts);
        const en = Number(r.MS_End||st+60*60*1000);
        const title = String(r.MS_Title||"Maintenance");
        out.push({
          id:"ts-"+r.ts,
          title,
          start:new Date(st),
          end:new Date(en),
          classNames:["event", colorByStatus(r.MS_Status)],
          extendedProps:{
            MS_Title:r.MS_Title||"",
            MS_Machine:r.MS_Machine||"",
            MS_Type:r.MS_Type||"",
            MS_Priority:r.MS_Priority||"",
            MS_Date: Number(r.MS_Date||midnightMs(new Date(st).toISOString().slice(0,10))),
            MS_Start:st, MS_End:en,
            MS_Status:r.MS_Status||"Planned",
            MS_Description:r.MS_Description||"",
            MS_Technicians:r.MS_Technicians||"",
            MS_Task:r.MS_Task||"",
            __ts:r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ AUTO-REFRESH (5s, 3 min max) ************/
var _autoTimer=null,_autoDeadline=0;
function stopAutoRefresh(){ if(_autoTimer){ clearInterval(_autoTimer); _autoTimer=null; } }
function startAutoRefresh(expectedTs, predicate){
  stopAutoRefresh(); _autoDeadline = Date.now()+3*60*1000;
  _autoTimer = setInterval(function(){
    if(Date.now()>_autoDeadline){ stopAutoRefresh(); loading("Stopped: timeout waiting for telemetry update"); return; }
    if(!state.lastRange) return;
    readRange(state.lastRange.start, state.lastRange.end).then(function(events){
      state.calendar.removeAllEvents(); state.calendar.addEventSource(events);
      loading("Loaded "+events.length+" task(s) — auto-refreshing…");
      if(expectedTs!=null){
        const found = events.find(ev => String(ev.extendedProps.__ts)===String(expectedTs));
        if(found){
          if(typeof predicate==="function"){
            try{ if(predicate(found)){ stopAutoRefresh(); loading("Update detected ✓"); } }catch(e){}
          } else { stopAutoRefresh(); loading("Update detected ✓"); }
        }
      }
    }).catch(err=>{ console.error(err); loading("Auto-refresh error: "+(err.message||err)); });
  },5000);
}

/************ WRITE ************/
function writeAttributes(payload, opts){
  if(!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));
  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";
  const body = {
    MS_Title: payload.MS_Title,
    MS_Machine: payload.MS_Machine,
    MS_Type: payload.MS_Type,
    MS_Priority: payload.MS_Priority,
    MS_Date: payload.MS_Date,
    MS_Start: payload.MS_Start,
    MS_End: payload.MS_End,
    MS_Status: payload.MS_Status,
    MS_Description: payload.MS_Description || "",
    MS_Technicians: payload.MS_Technicians || "",
    MS_Task: payload.MS_Task || ""
  };
  if (opts && opts.mode==="create"){
    body[ATTR_MS_SAVE_FLAG] = false;
  } else if (opts && (opts.mode==="update" || opts.mode==="cancel")){
    body[ATTR_MS_UPDATE_FLAG] = true;
    if (payload[ATTR_MS_UPDATE_TS]) body[ATTR_MS_UPDATE_TS] = payload[ATTR_MS_UPDATE_TS];
  }
  return fetch(url,{
    method:"POST",
    headers:{ "X-Authorization":"Bearer "+JWT, "Content-Type":"application/json" },
    body: JSON.stringify(body)
  }).then(res=>res.ok?null:res.text().then(t=>{throw new Error("Attribute write failed: "+t);})); 
}

/************ DETAILS PANEL ************/
function showDetails(ev){
  state.selectedEvent = ev;
  const p = ev.extendedProps;
  const fmt = v => v ? new Date(Number(v)).toLocaleString() : "-";
  const tasks = String(p.MS_Task||"").split(",").map(s=>s.trim()).filter(Boolean);
  $("#details").className = "";
  $("#details").innerHTML =
    '<div class="kpi">'+
      '<span>Base ts</span><span>'+String(p.__ts||"-")+'</span>'+
      '<span>Title</span><span>'+escapeHtml(p.MS_Title||"-")+'</span>'+
      '<span>Machine</span><span>'+escapeHtml(p.MS_Machine||"-")+'</span>'+
      '<span>Type</span><span>'+escapeHtml(p.MS_Type||"-")+'</span>'+
      '<span>Priority</span><span>'+escapeHtml(p.MS_Priority||"-")+'</span>'+
      '<span>Status</span><span>'+escapeHtml(p.MS_Status||"-")+'</span>'+
      '<span>Technicians</span><span>'+escapeHtml(p.MS_Technicians||"-")+'</span>'+
      '<span>Start</span><span>'+fmt(p.MS_Start)+'</span>'+
      '<span>End</span><span>'+fmt(p.MS_End)+'</span>'+
      '<span>Description</span><span>'+escapeHtml(p.MS_Description||"-")+'</span>'+
      '<span>Tasks</span><span>'+ (tasks.length? ('<ul style="margin:0;padding-left:18px">'+tasks.map(t=>'<li>'+escapeHtml(t)+'</li>').join('')+'</ul>'):'-') +'</span>'+
    '</div>';
  $("#sideActions").style.display = "flex";
}

/************ MODAL: tabs, chips ************/
var overlay=$("#overlay");
function switchTab(id){
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b.dataset.tab===id));
  document.querySelectorAll(".tab-pane").forEach(p=>p.classList.toggle("active", p.id===id));
}
document.querySelectorAll(".tab-btn").forEach(b=>{
  b.addEventListener("click", ()=>switchTab(b.dataset.tab));
});

function refreshChips(list, boxSel){
  const box=$(boxSel); box.innerHTML="";
  list.forEach((val,idx)=>{
    const el=document.createElement("span");
    el.className="chip";
    el.innerHTML='<span>'+escapeHtml(val)+'</span><button type="button">✕</button>';
    el.querySelector("button").addEventListener("click", ()=>{ list.splice(idx,1); refreshChips(list,boxSel); });
    box.appendChild(el);
  });
}
function addTo(list, inputSel, boxSel){
  const raw = ($(inputSel).value||"").trim();
  if(!raw) return;
  if(!list.includes(raw)) list.push(raw);
  $(inputSel).value=""; refreshChips(list, boxSel);
}
$("#addTechBtn").addEventListener("click", ()=>addTo(state.techs, "#techOne", "#techChips"));
$("#techOne").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addTo(state.techs, "#techOne", "#techChips"); } });

$("#addTaskBtn").addEventListener("click", ()=>addTo(state.tasks, "#taskOne", "#taskChips"));
$("#taskOne").addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addTo(state.tasks, "#taskOne", "#taskChips"); } });

$("#btnBulkToChips").addEventListener("click", ()=>{
  const lines = ($("#taskBulk").value||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  lines.forEach(l=>{ if(!state.tasks.includes(l)) state.tasks.push(l); });
  $("#taskBulk").value=""; refreshChips(state.tasks, "#taskChips");
});

/************ CREATE / UPDATE / CANCEL ************/
function openModal(date){
  state.mode="create";
  $("#modalTitle").textContent="Add maintenance"; $("#saveBtn").textContent="Save";
  // Defaults
  $("#fTitle").value=""; $("#fMachine").value=""; $("#fType").value="Preventive";
  $("#fPriority").value="2"; $("#fStatus").value="Planned";
  const d = date || new Date();
  const iso = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  $("#fDate").value = iso; $("#fStart").value="09:00"; $("#fEnd").value="11:00";
  $("#fDesc").value="";
  state.techs=[]; refreshChips(state.techs, "#techChips");
  state.tasks=[]; refreshChips(state.tasks, "#taskChips"); $("#taskBulk").value="";
  switchTab("tab-details");
  overlay.style.display="flex";
}
function collectPayload(){
  const dateStr = $("#fDate").value;
  return {
    MS_Title: ($("#fTitle").value||"").trim(),
    MS_Machine: ($("#fMachine").value||"").trim(),
    MS_Type: $("#fType").value,
    MS_Priority: $("#fPriority").value,
    MS_Date: midnightMs(dateStr),
    MS_Start: mergeDateAndTime(dateStr, $("#fStart").value),
    MS_End:   mergeDateAndTime(dateStr, $("#fEnd").value),
    MS_Status: $("#fStatus").value,
    MS_Description: ($("#fDesc").value||"").trim(),
    MS_Technicians: state.techs.join(", "),
    MS_Task: state.tasks.join(", ")
  };
}
function validatePayload(p){
  const must = [
    ["Title", p.MS_Title],
    ["Machine", p.MS_Machine],
    ["Date", p.MS_Date],
    ["Start/End time", (p.MS_End>p.MS_Start)]
  ];
  for (let i=0;i<must.length;i++){ if(!must[i][1]) return "Please provide "+must[i][0]; }
  return "";
}

$("#btnNew").addEventListener("click", ()=>openModal(new Date()));
$("#closeModal").addEventListener("click", ()=>overlay.style.display="none");

$("#saveBtn").addEventListener("click", function(){
  if(state.mode==="update") return onUpdate();
  return onCreate();
});

$("#btnEdit").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  const p = state.selectedEvent.extendedProps;
  state.mode="update"; $("#modalTitle").textContent="Update maintenance"; $("#saveBtn").textContent="Update";
  // Fill
  $("#fTitle").value = p.MS_Title||"";
  $("#fMachine").value = p.MS_Machine||"";
  $("#fType").value = p.MS_Type||"Preventive";
  $("#fPriority").value = String(p.MS_Priority||"2");
  $("#fStatus").value = p.MS_Status||"Planned";
  const iso = new Date(Number(p.MS_Date||p.MS_Start)).toISOString().slice(0,10);
  $("#fDate").value = iso;
  $("#fStart").value = msToHHMM(p.MS_Start);
  $("#fEnd").value   = msToHHMM(p.MS_End);
  $("#fDesc").value  = p.MS_Description||"";
  state.techs = String(p.MS_Technicians||"").split(",").map(s=>s.trim()).filter(Boolean);
  state.tasks = String(p.MS_Task||"").split(",").map(s=>s.trim()).filter(Boolean);
  refreshChips(state.techs, "#techChips");
  refreshChips(state.tasks, "#taskChips");
  switchTab("tab-details");
  overlay.style.display="flex";
});

$("#btnCancel").addEventListener("click", function(){
  if(!state.selectedEvent){ alert("Select a task first."); return; }
  if(!confirm("Cancel this maintenance task?")) return;
  const p = state.selectedEvent.extendedProps;
  const payload = {
    MS_Title:p.MS_Title, MS_Machine:p.MS_Machine, MS_Type:p.MS_Type,
    MS_Priority:p.MS_Priority, MS_Date:p.MS_Date, MS_Start:p.MS_Start, MS_End:p.MS_End,
    MS_Status:"Cancelled", MS_Description:p.MS_Description,
    MS_Technicians:p.MS_Technicians, MS_Task:p.MS_Task
  };
  payload[ATTR_MS_UPDATE_TS] = p.__ts;
  loading("Cancelling…");
  writeAttributes(payload, {mode:"cancel"}).then(()=>{
    startAutoRefresh(payload[ATTR_MS_UPDATE_TS], found => String(found.extendedProps.MS_Status).toLowerCase()==="cancelled");
  }).catch(err=>{ console.error(err); alert(err.message||"Failed to cancel"); });
});

function onCreate(){
  const payload = collectPayload();
  const err = validatePayload(payload); if(err){ alert(err); return; }
  loading("Saving…");
  writeAttributes(payload, {mode:"create"}).then(()=>{
    overlay.style.display="none";
    // RC should write telemetry at ts = MS_Start
    startAutoRefresh(payload.MS_Start, null);
  }).catch(err=>{ console.error(err); alert(err.message||"Failed to save"); });
}
function onUpdate(){
  if(!state.selectedEvent){ alert("No task selected"); return; }
  const payload = collectPayload();
  payload[ATTR_MS_UPDATE_TS] = state.selectedEvent.extendedProps.__ts;
  const err = validatePayload(payload); if(err){ alert(err); return; }
  loading("Updating…");
  writeAttributes(payload, {mode:"update"}).then(()=>{
    overlay.style.display="none";
    startAutoRefresh(payload[ATTR_MS_UPDATE_TS], found=>{
      const p = found.extendedProps||{};
      return String(p.MS_Title||"")===payload.MS_Title &&
             String(p.MS_Status||"")===payload.MS_Status &&
             String(p.MS_Machine||"")===payload.MS_Machine &&
             Number(p.MS_Start||0)===Number(payload.MS_Start||0) &&
             Number(p.MS_End||0)===Number(payload.MS_End||0) &&
             String(p.MS_Task||"")===String(payload.MS_Task||"");
    });
  }).catch(err=>{ console.error(err); alert(err.message||"Failed to update"); });
}

/************ CALENDAR ************/
function startCalendar(){
  if(!window.FullCalendar){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>'; return;
  }
  if(!JWT){
    document.getElementById('calendar').innerHTML =
      '<div class="empty"><span class="err">Missing JWT (?token=…)</span></div>'; return;
  }
  const calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    height: "auto",
    eventContent: eventContent,
    dateClick: (info)=>openModal(info.date),
    eventClick: (info)=>showDetails(info.event),
    datesSet: (info)=>{
      loading("Loading…");
      state.lastRange = { start: info.start, end: info.end };
      readRange(info.start, info.end).then(events=>{
        state.calendar.removeAllEvents(); state.calendar.addEventSource(events);
        $("#details").className="empty"; $("#details").textContent="Select a task";
        $("#sideActions").style.display="none";
        loading("Loaded "+events.length+" task(s)");
      }).catch(err=>{
        console.error(err); loading(err.message||"Failed to load");
        state.calendar.removeAllEvents();
      });
    }
  });
  state.calendar.render();
}
if (document.readyState==="complete" || document.readyState==="interactive") setTimeout(startCalendar,0);
else document.addEventListener("DOMContentLoaded", startCalendar);
</script>
</body>
</html>
